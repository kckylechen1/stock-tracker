---
description: 2026-01-09 工作日总结 - AI 助手综合分析工具 + 提示词优化
---

# 2026-01-09 工作日总结

## 📋 今日目标

根据两份核心参考文档，优化 AI 助手的分析能力，让它能够进行多维度综合分析。

## 📚 参考文档

### 1. NLP Strategy Design (`nlp-strategy-design.md`)

**核心理念**：

- 用自然语言描述投资逻辑 → LLM 解析 → 转换为因子/筛选规则
- 系统长期记住用户的筛选、复盘结果、成功/失败案例
- 把"经常被使用且有效"的逻辑抽象成可复用的 Skill

**关键模块**：

1. NLP/LLM 层 - 解析自然语言策略
2. 因子 & 数据引擎 - 执行筛选
3. Skill 管理与回测 - 验证有效性
4. 记忆与画像系统 - 长期记住用户偏好

### 2. Stock Trading Analysis Guide (`stock-trading-analysis-guide.md`)

**分析框架**：

- 日K 判断大方向（"没走弱"5项检查）
- 5分钟找精确进场点（旗形/箱体/均线粘合）
- 分批进场策略（三层进场法）
- 止损位设置（激进/稳健/保守）

**"没走弱"检查清单**：

1. 收盘价在 MA5 之上？
2. 收盘价在 MA10 之上？
3. MACD 红柱存在且扩大？
4. RSI 在 30 以上？
5. 成交量正常（无砸盘）？

**判定规则**：

- 满足 3 条以上 → 可考虑持有/回补
- 满足 2 条 → 谨慎观望
- 满足 1 条或以下 → 不应该进

---

## ✅ 今日完成的功能

### 1. 新增 AI 工具

| 工具名称                 | 文件位置                 | 功能                                 |
| ------------------------ | ------------------------ | ------------------------------------ |
| `comprehensive_analysis` | `stockTools.ts` L555-665 | 多维度综合分析（技术面+资金面+大盘） |
| `get_market_status`      | `stockTools.ts` L504-551 | 大盘环境判断（三大指数）             |

### 2. comprehensive_analysis 返回内容

```
【股票代码 综合分析报告】

📍 技术面分析
- "没走弱"判定 X/5
- MA/MACD/RSI 状态
- 持有建议

━━━━━━━━━━━━━━━━━━━━━━━━

📍 资金面分析
- 今日主力流向
- 近5日趋势

━━━━━━━━━━━━━━━━━━━━━━━━

📍 大盘环境
- 上证: X%  创业板: X%
- 判断: 🟢/🟡/🔴

━━━━━━━━━━━━━━━━━━━━━━━━

🎯 综合建议
- ✅/⚠️/❌ 操作建议
- 止损参考
```

### 3. 更新知识库 (`ai_knowledge.md`)

添加了工具使用优先级：

```
⭐ 核心分析工具（优先使用）
| comprehensive_analysis | 多维度综合分析 | 走势/分析问题首选 |
| get_market_status     | 大盘环境判断     | 大盘问题时调用 |
```

### 4. 优化 System Prompt (`streamChat.ts`)

**关键改进**：

1. **注入当前日期** - 解决模型以为是2023年的问题
2. **禁止偷懒规则** - 不允许直接复制粘贴工具结果
3. **固定回答结构** - 要求包含基本面/技术面/资金面/大盘/综合建议
4. **质量标准** - 像证券研究报告一样专业

**新的提示词结构**：

```
# 角色设定
你是"小A"，专业的A股分析师AI助手

# ⏰ 当前时间
今天是 2026年1月9日...

# 🎯 核心行为规则
- 规则1：走势分析必须调用 comprehensive_analysis
- 规则2：禁止偷懒！必须深度分析
- 规则3：回答必须包含固定结构

# 📊 记忆（预加载的股票数据）
# 📚 知识库
# 💎 分析质量标准
```

---

## 📁 修改的文件清单

| 文件                           | 修改内容                                                        |
| ------------------------------ | --------------------------------------------------------------- |
| `server/_core/stockTools.ts`   | 新增 comprehensive_analysis, get_market_status 工具定义和执行器 |
| `server/_core/streamChat.ts`   | 优化 System Prompt，注入日期，添加深度分析要求                  |
| `server/_core/ai_knowledge.md` | 更新工具列表和使用规则                                          |

---

## 🐛 发现的问题

### 问题1：模型日期认知错误

**现象**：AI 回答"今天是2023年11月2日"
**原因**：DeepSeek 训练数据截止2023年
**解决**：在 System Prompt 中直接注入当前日期

### 问题2：工具调用后变懒

**现象**：有了工具后，AI 直接复制粘贴工具结果，不做深度分析
**原因**：V3 模型有工具后倾向于"偷懒"
**解决**：在提示词中明确禁止直接复制，要求用自己的话重新组织

### 问题3：Function Calling 与 Thinking 模式不兼容

**现象**：DeepSeek R1（Thinking 模式）不支持 Function Calling
**现状**：暂未解决，可考虑两阶段调用方案

---

## 💡 Grok 提供的关键方案（值得记录）

**背景**：用户把 DeepSeek 回答太差的问题发给 Grok，Grok 给出了三个改进方案。

### 方案1：工具"内化推理"（已实现 ✅）

**核心思路**：问题不在模型，在工具！让工具自己"带脑子"，返回带结论的数据，模型只需润色。

**改进的文件**：

- `technicalAnalysis.ts` - 添加分批进场建议、综合结论
- `minutePatterns.ts` - 添加早盘分析、形态识别结论

### 方案2：反思闭环（待实现）

生成初稿后自动追问一次"以上回答是否足够具体？"

### 方案3：Grok API（可选）

主模型用 V3，关键问题切换 Grok-4。

### 🤔 Claude 的反思

Grok 一眼看穿问题本质，而我绕了一大圈。我应该早点意识到：模型不是笨，是工具返回的数据太"裸"了。

---

## 🔬 模型对比测试

测试问题：用户买了新易盛亏了，问早上有没有信号

| 模型            | 耗时 | 早盘分析             | 操作建议          | 结论    |
| --------------- | ---- | -------------------- | ----------------- | ------- |
| **DeepSeek V3** | 17s  | ✅ 提到10:45放量下跌 | ✅ 减50%，380止损 | 🏆 更好 |
| Qwen 2.5-72B    | 32s  | ❌ 没提              | ⚠️ 模糊           | 不如V3  |

**结论**：不需要换模型！继续用 V3，重点优化工具输出质量。

---

## 💡 后续优化方向

1. **股吧人气排名**（下一步优先）：
   - `stock_hot_rank_latest_em` - 获取当前排名和变化
   - `stock_hot_rank_detail_realtime_em` - 获取排名趋势
   - 可用于判断市场情绪和散户关注度

2. **反思闭环**：生成初稿后自动追问一次"是否足够具体"
3. **5分钟形态识别优化**：进一步调优形态识别参数
4. **交易记忆实际应用**：在分析时自动调用用户历史教训

---

## 📊 技术栈

- **后端**：Node.js + TypeScript + Express
- **AI 模型**：DeepSeek V3（Function Calling）/ DeepSeek R1（Thinking）
- **数据源**：AKTools（AKShare HTTP API）
- **前端**：React + Vite

---

## 🔗 相关文档

- `/Users/kckylechen/Desktop/Stock Tracker/nlp-strategy-design.md`
- `/Users/kckylechen/Desktop/Stock Tracker/stock-trading-analysis-guide.md`
- `/Users/kckylechen/Desktop/Stock Tracker/stock-tracker/server/_core/ai_knowledge.md`
