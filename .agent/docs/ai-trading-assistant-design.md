# AI 交易助手系统设计

## 概述

这个系统实现了类似 Perplexity 的 **结构化推理流程**，让 AI 助手能够：
1. 记住用户的持仓和操作历史
2. 主动调用 API 获取实时数据
3. 结合历史经验给出建议
4. 避免重蹈覆辙

## 系统架构

```
┌────────────────────────────────────────────────────────────────┐
│                        用户对话                                 │
└───────────────────────────┬────────────────────────────────────┘
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                  1. 📋 任务规划 (Planning)                      │
│                                                                │
│   Thought: 用户问「蓝思科技是否应该卖」，我需要：               │
│   1. 获取当前实时行情                                          │
│   2. 获取技术指标（RSI、MACD、KDJ）                            │
│   3. 获取资金流向数据                                          │
│   4. 查看用户的持仓成本和历史操作                              │
│   5. 检索相关的历史教训                                        │
│   6. 综合分析并给出建议                                        │
└───────────────────────────┬────────────────────────────────────┘
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                  2. 🔍 数据获取 (Execution)                     │
│                                                                │
│   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐      │
│   │ get_stock_   │   │ get_fund_    │   │ get_longhu_  │      │
│   │ quote        │   │ flow         │   │ bang         │      │
│   │              │   │              │   │              │      │
│   │ 实时行情     │   │ 资金流向     │   │ 龙虎榜       │      │
│   └──────────────┘   └──────────────┘   └──────────────┘      │
└───────────────────────────┬────────────────────────────────────┘
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                  3. 📚 记忆检索 (Memory)                        │
│                                                                │
│   从 trading_memory.json 加载：                                 │
│   ├─ 当前持仓（成本、数量、止盈止损）                          │
│   ├─ 历史交易记录                                              │
│   ├─ 历史教训（如"RSI<30不清仓"）                              │
│   └─ 用户偏好（风险偏好、交易风格）                            │
└───────────────────────────┬────────────────────────────────────┘
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                  4. 🧮 综合分析 (Synthesis)                     │
│                                                                │
│   ┌─────────────────┐                                          │
│   │ 实时数据        │                                          │
│   │ RSI=28（超卖）  │──┐                                       │
│   │ 主力净流入+2亿  │  │                                       │
│   └─────────────────┘  │   ┌─────────────────────────────┐     │
│                        ├──▶│       综合判断               │     │
│   ┌─────────────────┐  │   │                             │     │
│   │ 历史教训        │  │   │ 当前RSI=28，与上次卖飞时    │     │
│   │ RSI<30卖飞了    │──┘   │ 的RSI=25类似，不建议清仓    │     │
│   └─────────────────┘      └─────────────────────────────┘     │
└───────────────────────────┬────────────────────────────────────┘
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                  5. 💡 生成建议 (Output)                        │
│                                                                │
│   ### 📊 实时数据                                               │
│   - 当前价格、涨跌幅                                           │
│   - 技术指标（RSI、MACD、KDJ）                                 │
│   - 资金流向                                                   │
│                                                                │
│   ### 📈 技术分析                                               │
│   - 趋势判断、支撑位、压力位                                   │
│                                                                │
│   ### 📚 历史经验 ⚠️                                            │
│   - 相关的历史教训                                             │
│   - 过去类似情况的结果                                         │
│                                                                │
│   ### 💡 操作建议                                               │
│   - 具体操作建议                                               │
│   - 理由                                                       │
│   - 风险提示                                                   │
└────────────────────────────────────────────────────────────────┘
```

## 数据模型

### 1. Position（持仓）

```typescript
interface Position {
    symbol: string;       // 股票代码
    name: string;         // 股票名称
    cost: number;         // 成本价
    shares: number;       // 持仓数量
    buy_date: string;     // 买入日期
    buy_reason: string;   // 买入理由
    stock_type: string;   // 'value' | 'momentum' | 'hot_money'
    target_price?: number; // 目标价
    stop_loss?: number;   // 止损价
}
```

### 2. Trade（交易记录）

```typescript
interface Trade {
    symbol: string;
    action: 'buy' | 'sell';
    price: number;
    shares: number;
    date: string;
    reason: string;
    technical_signals: {  // 交易时的技术信号
        rsi: number;
        macd: string;
        volume: string;
    };
    outcome?: 'good' | 'bad' | 'neutral';  // 事后评价
    lessons_learned?: string;              // 经验教训
}
```

### 3. TradingLesson（交易教训）

```typescript
interface TradingLesson {
    date: string;
    symbol: string;       // 具体股票或 '*'（通用）
    lesson: string;       // 教训内容
    signal_pattern: string;  // 触发信号模式
    action_to_avoid: string; // 应该避免的行为
    recommended_action: string; // 推荐的行为
}
```

### 4. UserProfile（用户画像）

```typescript
interface UserProfile {
    risk_tolerance: 'low' | 'medium' | 'high';
    holding_period: 'short' | 'medium' | 'long';
    preferred_indicators: string[];
    avoid_patterns: string[];   // 避免的模式
    success_patterns: string[]; // 成功的模式
}
```

## 记忆系统工作流程

### 1. 加载记忆
每次对话开始时，从文件加载用户的记忆：
```typescript
const memory = loadTradingMemory('trading_memory.json');
```

### 2. 注入上下文
将记忆转换为系统提示词的一部分：
```typescript
const userContext = generateUserContext(memory, currentSymbol);
const systemPrompt = TRADING_ASSISTANT_SYSTEM_PROMPT + '\n' + userContext;
```

### 3. 更新记忆
当用户确认交易或反馈时，更新记忆：
```typescript
memory.addTrade(newTrade);
memory.addLesson(newLesson);
memory.save('trading_memory.json');
```

## 关键设计决策

### 1. 为什么用文件而不是数据库？
- 简单：不需要额外的数据库服务
- 便携：记忆文件可以备份和迁移
- 可读：JSON 格式便于调试

### 2. 为什么用 System Prompt 而不是 RAG？
- 上下文短：交易记忆通常不会超过几十条
- 延迟低：不需要额外的向量搜索
- 可控：所有上下文都是结构化的

### 3. 如何避免 Hallucination？
- 强制工具调用：在给建议前必须获取实时数据
- 结构化输出：固定的输出格式减少自由发挥
- 历史验证：建议必须与历史教训一致

## 使用示例

### 用户问：蓝思科技现在可以卖吗？

**AI 内部思考过程**:
```
Thought: 
1. 用户持有蓝思科技，成本25.5元，1000股
2. 上次在RSI<30时卖出导致卖飞10%
3. 需要获取当前行情和技术指标
4. 检查资金流向

Searching: 调用 get_stock_quote('300433')...
Searching: 调用 get_fund_flow('300433')...

Reviewing: 当前RSI=28，处于超卖区，与上次类似

Thought: 根据历史教训，不建议在超卖区清仓
```

**AI 输出**:
```markdown
### 📊 实时数据
| 指标 | 数值 | 信号 |
|------|------|------|
| 当前价格 | 26.50元 | 涨+3.12% |
| RSI(14) | 28 | ⚠️ 超卖区 |
| MACD | DIF<DEA | 死叉 |
| 主力资金 | +2.1亿 | 🟢 流入 |

### 📈 技术分析
- **当前状态**: RSI处于超卖区，但有企稳迹象
- **支撑位**: 25.00元
- **压力位**: 28.50元

### 📚 历史经验 ⚠️
根据你的历史记录，你在2026-01-08曾在RSI=25时清仓，错过了第二天10%的反弹。
当前RSI=28，与上次情况类似。

### 💡 操作建议
**建议**: 持有观望，不建议现在清仓
**理由**: 
1. RSI=28处于超卖区，技术上有反弹需求
2. 主力资金今日净流入2.1亿，说明有资金抄底
3. 你的成本价25.5元，当前价格26.5元，有小幅盈利
4. **历史教训**: 上次类似情况卖飞了

**风险提示**: 如果跌破止损位22元，建议严格执行止损
```

## TODO

- [ ] 实现记忆持久化 API
- [ ] 添加记忆管理 UI（查看、编辑、删除）
- [ ] 实现自动记录交易功能
- [ ] 添加复盘功能（批量分析历史操作）
- [ ] 支持多用户（按用户隔离记忆）
