# 牛股信号系统升级说明

## 功能更新概览

### 1. 自动检测启动日 ✅

**问题**: 之前需要手动指定启动日期，效率低且容易遗漏机会

**解决方案**: 实现 `detectLaunchDay()` 函数，自动识别符合以下条件的启动日：
- 收盘价突破20日高点3%以上
- 成交量超过20日均值2倍以上  
- 收盘价涨幅超过5%（大阳线）

**代码实现**:
```typescript
function detectLaunchDay(klines: KlineData[], lookback = 60): string | null {
    for (let i = lookback; i < klines.length; i++) {
        const today = klines[i];
        const prev20Days = klines.slice(i - 20, i);
        const prev20High = Math.max(...prev20Days.map(k => k.high));
        const prev20AvgVol = prev20Days.reduce((sum, k) => sum + k.volume, 0) / 20;
        
        const isBreakout = today.close > prev20High * 1.03;
        const isHighVolume = today.volume > prev20AvgVol * 2;
        const isBigUp = today.close > today.open * 1.05;
        
        if (isBreakout && isHighVolume && isBigUp) {
            return today.date;
        }
    }
    return null;
}
```

### 2. 一键扫全市场 ✅

**问题**: 手动添加测试股票，无法覆盖全市场

**解决方案**: 实现 `scanMarketForBullStocks()` 函数，支持：
- 批量扫描指定股票列表
- 自动检测启动日
- 计算当前技术指标
- 按综合评分排序展示机会
- 显示买入/卖出信号

**使用方法**:
```bash
# 回测模式（指定股票）
npx tsx server/bull_stock_signal_backtest.ts backtest

# 扫描模式（自动检测）
npx tsx server/bull_stock_signal_backtest.ts scan
```

**示例输出**:
```
╔════════════════════════════════════════════════════════════════════════════════╗
║   牛股市场扫描                                        ║
║   自动检测启动日，扫描全市场寻找牛股机会              ║
╚═════════════════════════════════════════════════════════════╝

📡 获取股票列表...
✅ 获取到 14 只股票

🔍 扫描市场寻找牛股机会...
✅ 发现 1 个牛股机会

════════════════════════════════════════════════════════════════════════════════
📈 牛股机会排序（按综合评分）

1. 金山办公(688111)
   启动日期: 2026-01-05
   启动价格: 327.00元
   当前价格: 341.50元
   涨幅: +4.43%
   综合评分: 70/100
   买入信号:
     ✅ MA5 > MA10
     ✅ MACD 红柱
     ✅ RSI 强势
     ✅ KDJ 金叉
     ✅ 放量上涨
```

### 3. 卖出/止损信号系统 ✅

**问题**: 只有买入信号，缺乏卖出/止损机制

**解决方案**: 添加完整的风险控制信号

#### 卖出信号规则

| 信号 | 条件 | 扣分 |
|-----|------|------|
| 均线空头排列 | MA5 < MA10 < MA20 < MA60 | -15分 |
| MA5下穿MA10 | MA5 < MA10 | -15分 |
| MACD死叉 | histogram < 0 且前一日 ≥ 0 | -15分 |
| MACD绿柱 | histogram < 0 | -10分 |
| RSI跌破50 | RSI < 50 | -10分 |
| 缩量 | 量比 < 0.7 | -10分 |

#### 风险控制规则

**触发减仓/清仓的条件**:
1. 综合评分 < 30
2. 当前价格跌破启动日低点

#### 代码实现

```typescript
// 生成卖出信号列表
const sellSignals: string[] = [];
let sellScore = 0;

// MA5下穿MA10 → -15分
if (maArrangement === '空头排列') {
    sellSignals.push('❌ 均线空头排列');
    sellScore -= 15;
} else if (lastMA5 < lastMA10) {
    sellSignals.push('❌ MA5 < MA10');
    sellScore -= 15;
}

// MACD死叉 → -15分
if (macdSignal === '死叉') {
    sellSignals.push('❌ MACD 死叉');
    sellScore -= 15;
} else if (macdSignal === '绿柱') {
    sellSignals.push('❌ MACD 绿柱');
    sellScore -= 10;
}

// RSI跌破50 → -10分
if (rsiValue < 50) {
    sellSignals.push('❌ RSI < 50');
    sellScore -= 10;
}

// 缩量 → -10分
if (volStatus === '缩量') {
    sellSignals.push('❌ 缩量');
    sellScore -= 10;
}

const totalScore = Math.max(0, score + sellScore);
```

#### Interface更新

```typescript
interface IndicatorResult {
    date: string;
    price: number;
    ma5: number;
    ma10: number;
    ma20: number;
    ma60: number;
    maArrangement: string;
    macd: { dif: number; dea: number; histogram: number; signal: string };
    rsi: { value: number; signal: string };
    kdj: { k: number; d: number; j: number; signal: string };
    volume: { ratio: number; status: string };
    gaugeScore: number;      // 买入信号得分
    signals: string[];       // 买入信号列表
    sellSignals: string[];   // 卖出信号列表 (新增)
    totalScore: number;       // 综合得分 (买入 - 卖出) (新增)
}
```

---

## 使用示例

### 回测模式 - 验证历史表现

```bash
npx tsx server/bull_stock_signal_backtest.ts backtest
```

**适用场景**:
- 验证信号在历史上的有效性
- 研究特定股票的启动特征
- 优化信号参数

**输出内容**:
- 每只股票的启动前、启动当天、启动后1天的技术指标
- 信号有效性统计
- 高涨幅股票特征总结
- 高频信号分析

### 扫描模式 - 发现当前机会

```bash
npx tsx server/bull_stock_signal_backtest.ts scan
```

**适用场景**:
- 日常选股
- 发现潜在牛股
- 监控持仓风险

**输出内容**:
- 当前符合启动条件的股票列表
- 按综合评分排序
- 买入/卖出信号
- 涨幅和启动日期信息

---

## 风险控制建议

### 买入条件

**推荐买入**:
- 综合评分 ≥ 60
- 至少3个买入信号
- 无卖出信号
- 成交量放大

**观察**:
- 综合评分 40-59
- 2-3个买入信号
- 卖出信号 ≤ 1个

### 持有条件

**继续持有**:
- 综合评分 ≥ 40
- 买入信号 ≥ 卖出信号
- 未跌破启动日低点
- MACD仍为红柱

### 卖出条件

**减仓**:
- 综合评分 30-39
- 出现2个以上卖出信号
- 跌破启动日低点但有所反弹

**清仓**:
- 综合评分 < 30
- 出现3个以上卖出信号
- 跌破启动日低点且无反弹
- MACD死叉且RSI < 50

---

## 技术指标说明

### 买入信号（加分）

| 指标 | 信号 | 得分 | 说明 |
|-----|------|------|------|
| MA5 > MA10 | ✅ | 10 | 短期趋势向上 |
| 均线多头排列 | ✅ | 20 | 强势上涨趋势 |
| MACD金叉 | ✅ | 15 | 动能转正 |
| MACD红柱 | ✅ | 10 | 动能向上 |
| RSI强势(65-80) | ✅ | 20 | 强势但不超买 |
| RSI偏强(50-65) | ✅ | 15 | 稍强 |
| RSI超卖(<30) | ✅ | 10 | 反弹机会 |
| KDJ金叉 | ✅ | 15 | 短期转强 |
| KDJ J > 50 | ✅ | 10 | 短期动能强 |
| 放量上涨 | ✅ | 15 | 量价齐升 |
| 放量 | ✅ | 10 | 成交活跃 |

### 卖出信号（扣分）

| 指标 | 信号 | 扣分 | 说明 |
|-----|------|------|------|
| MA5 < MA10 | ❌ | -15 | 短期趋势向下 |
| 均线空头排列 | ❌ | -15 | 弱势下跌趋势 |
| MACD死叉 | ❌ | -15 | 动能转负 |
| MACD绿柱 | ❌ | -10 | 动能向下 |
| RSI < 50 | ❌ | -10 | 偏弱 |
| 缩量 | ❌ | -10 | 成交萎缩 |

---

## 改进效果

### 自动化程度提升

| 功能 | 改进前 | 改进后 |
|-----|-------|-------|
| 启动日识别 | 手动指定 | 自动检测 |
| 市场覆盖 | 手动添加股票 | 批量扫描 |
| 信号系统 | 仅有买入 | 买入+卖出 |
| 风险控制 | 无 | 完整风控体系 |

### 效率提升

- **启动日检测**: 从手动分析5分钟/股 → 自动检测<1秒/股
- **市场扫描**: 从逐个分析 → 批量扫描
- **风险管理**: 从人工判断 → 系统自动提示

---

## 后续优化方向

1. **扩大股票池**: 接入更多市场数据源，扫描全市场
2. **机器学习**: 基于历史数据训练模型，提高准确率
3. **实时监控**: WebSocket实时推送信号
4. **回测引擎**: 更完善的回测框架，支持策略优化
5. **可视化**: 图表展示信号与股价关系
6. **移动端**: 开发移动端App，随时查看信号

---

**更新日期**: 2026-01-11  
**版本**: v2.0  
**作者**: AI Trading System
